{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Historial de Reportes – Maestro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static 'conducta/css/historial.css' %}">
</head>

<body>
    <div class="historial-container">
        <ul class="nav nav-tabs mb-3" id="reportTabs" role="tablist">
            <!-- TAB 1: TICKETS -->
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-tickets" data-bs-toggle="tab" data-bs-target="#tickets"
                    type="button" role="tab">Tickets</button>
            </li>
            <!-- TAB 2: INFORMATIVO -->
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-informativo" data-bs-toggle="tab" data-bs-target="#informativo"
                    type="button" role="tab">Reporte Informativo</button>
            </li>
            <!-- TAB 3: CONDUCTUAL -->
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-conductual" data-bs-toggle="tab" data-bs-target="#conductual"
                    type="button" role="tab">Reporte Conductual</button>
            </li>
            <!-- TAB 4: PROGRESS (solo BL) -->
            {% if area == "bilingue" %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-progress" data-bs-toggle="tab" data-bs-target="#progress" type="button"
                    role="tab">Progress Report</button>
            </li>
            {% endif %}
        </ul>

        <div class="tab-content" id="reportTabsContent">
            <!-- TAB 1: TICKETS -->
            <div class="tab-pane fade show active" id="tickets" role="tabpanel">
                <h5 class="mb-3">Historial de Tickets</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle table-bordered" id="tabla-tickets">
                        <thead>
                            <tr class="table-secondary">
                                <th>TICKET ID</th>
                                <th>NAME</th>
                                <th>EMAIL</th>
                                <th>DESCRIPTION</th>
                                <th>ADJUNTO</th>
                                <th>STATUS</th>
                                <th>COMENTARIOS</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for t in tickets_usuario %}
                            <tr>
                                <td>
                                    {{ t.ticket_id }}
                                </td>
                                <td>{{ t.name }}</td>
                                <td>{{ t.email }}</td>
                                <td>
                                    <span class="text-truncate d-inline-block" style="max-width:150px;">
                                        {{ t.description|truncatechars:30 }}
                                    </span>
                                </td>
                                <td>
                                    {% if t.attachment %}
                                    <a href="{{ t.attachment.url }}" target="_blank"
                                        class="btn btn-sm btn-outline-secondary">Ver</a>
                                    {% else %}
                                    <span class="text-muted">No</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-info text-dark">{{ t.status }}</span>
                                </td>
                                <td>
                                    <a href="{% url 'ticket_comments' t.id %}?area={{ area }}"
                                        class="btn btn-sm btn-outline-primary btn-chat" data-ticket-id="{{ t.id }}"
                                        data-nombre="{{ t.name }}" data-area="{{ area }}"
                                        title="Ver conversación del ticket">
                                        <i class="bi bi-chat-dots"></i> Chat
                                    </a>

                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center">No hay tickets registrados.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- TAB 2: INFORMATIVO -->
            <div class="tab-pane fade" id="informativo" role="tabpanel">
                <h5 class="mb-3">Historial de Reportes Informativos</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle table-bordered">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Estudiante</th>
                                <th>Grado</th>
                                <th>Materia</th>
                                <th>Docente</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in reportes_informativo %}
                            <tr>
                                <td>{{ r.id }}</td>
                                <td>{{ r.alumno_nombre }}</td>
                                <td>{{ r.grado }}</td>
                                <td>{{ r.materia }}</td>
                                <td>{{ r.docente }}</td>
                                <td>{{ r.fecha|date:"Y-m-d H:i" }}</td>
                                <td>
                                    <a href="{% url 'descargar_pdf_informativo' r.id %}"
                                        class="btn btn-sm btn-outline-danger" target="_blank">Ver PDF</a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center">No hay reportes informativos.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- TAB 3: CONDUCTUAL -->
            <div class="tab-pane fade" id="conductual" role="tabpanel">
                <h5 class="mb-3">Historial de Reportes Conductuales</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle table-bordered">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Estudiante</th>
                                <th>Grado</th>
                                <th>Materia</th>
                                <th>Docente</th>
                                <th>Fecha</th>
                                <th>Individual</th>
                                <th>Tres Strikes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in reportes_conductual %}
                            <tr>
                                <td>{{ r.id }}</td>
                                <td>{{ r.alumno_nombre }}</td>
                                <td>{{ r.grado }}</td>
                                <td>{{ r.materia }}</td>
                                <td>{{ r.docente }}</td>
                                <td>{{ r.fecha|date:"Y-m-d H:i" }}</td>
                                <td>
                                    <a href="{% url 'descargar_pdf_conductual' r.id %}"
                                        class="btn btn-sm btn-outline-secondary" target="_blank">Ver PDF</a>
                                </td>
                                <td>
                                    <a href="{% url 'descargar_pdf_conductual_3_strikes' r.id %}"
                                        class="btn btn-sm btn-outline-danger">PDF 3 Strikes</a>

                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center">No hay reportes conductuales.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- TAB 4: PROGRESS REPORT (SOLO BL) -->
            {% if area == "bilingue" %}
            <div class="tab-pane fade" id="progress" role="tabpanel">
                <h5 class="mb-3">Historial de Progress Reports</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle table-bordered">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Estudiante</th>
                                <th>Grado</th>
                                <th>Semana Inicio</th>
                                <th>Semana Fin</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in reportes_progress %}
                            <tr>
                                <td>{{ r.id }}</td>
                                <td>{{ r.alumno_nombre }}</td>
                                <td>{{ r.grado }}</td>
                                <td>{{ r.semana_inicio }}</td>
                                <td>{{ r.semana_fin }}</td>
                                <td>{{ r.fecha|date:"Y-m-d H:i" }}
                                <td>
                                    <a href="{% url 'editar_progress_report' r.id %}"
                                        class="btn btn-sm btn-primary">Editar</a>
                                </td>

                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center">No hay progress reports.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
        <a class="btn-dashboard text-center mt-4" href="/conducta/dashboard/maestro/">
            &larr; Regresar al Dashboard
        </a>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="{% static 'conducta/js/historial.js' %}"></script>
</body>

</html>