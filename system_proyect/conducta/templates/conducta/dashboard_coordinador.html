{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Coordinador – {{ area|title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet"/>
    <!-- Icons Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Personalizado -->
    <link href="{% static 'conducta/css/coordinador.css' %}" rel="stylesheet"/>
</head>
<body>
<div class="container py-4">
    <a href="{% url 'menu' %}" class="btn btn-outline-secondary mb-3">&larr; Volver al Menú</a>
    <h2 class="mb-4 text-center">Dashboard Coordinador ({{ area|title }})</h2>

    <div class="table-responsive shadow-sm">
        <table id="tabla-coordinador" class="table table-bordered table-hover align-middle" style="width:100%;">
            <thead class="table-dark">
                <tr>
                    <th>Alumno</th>
                    <th>Tipo</th>
                    <th>Fecha</th>
                    <th>Grado</th>
                    <th>Docente</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
            {# --- Iterar Informativos --- #}
            {% for r in reportes_informativo %}
                <tr>
                    <td>{{ r.alumno_nombre }}</td>
                    <td><span class="badge bg-info">Informativo</span></td>
                    <td>{{ r.fecha|date:"d/m/Y" }}</td>
                    <td>{{ r.grado }}</td>
                    <td>{{ r.docente }}</td>
                    <td>
                        <span class="badge bg-success">Activo</span>
                    </td>
                    <td>
                        <!-- Editar -->
                        <a href="{% url 'editar_reporte_informativo' r.pk %}" class="btn btn-primary btn-sm" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <!-- QR / PDF -->
                        <a href="{% url 'descargar_pdf_informativo' r.pk %}" class="btn btn-secondary btn-sm" title="Descargar PDF/QR" target="_blank">
                            <i class="bi bi-qr-code"></i>
                        </a>
                        <!-- PowerPoint solo progress, no aplica aquí -->
                        <button class="btn btn-warning btn-sm d-none" title="Descargar PowerPoint" disabled>
                            <i class="bi bi-file-earmark-ppt"></i>
                        </button>
                        <!-- Historial alumno -->
                        <button class="btn btn-info btn-sm btn-historial" data-alumno="{{ r.alumno_id }}" title="Ver Historial">
                            <i class="bi bi-clock-history"></i>
                        </button>
                        <!-- 3 Strikes (solo si tiene 3+) -->
                        {% if strikes.r.alumno_id %}
                        <a href="{% url 'reporte_general_tres_faltas_bilingue' %}?alumno_id={{ r.alumno_id }}" class="btn btn-danger btn-sm" title="3 Strikes">
                            <i class="bi bi-exclamation-triangle"></i>
                        </a>
                        {% else %}
                        <button class="btn btn-danger btn-sm d-none" disabled>
                            <i class="bi bi-exclamation-triangle"></i>
                        </button>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            {# --- Iterar Conductuales --- #}
            {% for r in reportes_conductual %}
                <tr>
                    <td>{{ r.alumno_nombre }}</td>
                    <td><span class="badge bg-warning text-dark">Conductual</span></td>
                    <td>{{ r.fecha|date:"d/m/Y" }}</td>
                    <td>{{ r.grado }}</td>
                    <td>{{ r.docente }}</td>
                    <td>
                        <span class="badge bg-success">Activo</span>
                    </td>
                    <td>
                        <!-- Editar -->
                        <a href="{% url 'editar_reporte_conductual' r.pk %}" class="btn btn-primary btn-sm" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <!-- QR / PDF -->
                        {% if strikes.r.alumno_id %}
                            <a href="{% url 'descargar_pdf_conductual' r.pk %}" class="btn btn-secondary btn-sm" title="Descargar PDF/QR">
                                <i class="bi bi-qr-code"></i>
                            </a>
                        {% else %}
                            <button class="btn btn-secondary btn-sm btn-pdf-disabled" data-alumno="{{ r.alumno_id }}" title="Faltan reportes">
                                <i class="bi bi-qr-code"></i>
                            </button>
                        {% endif %}
                        <!-- PowerPoint solo progress, no aplica aquí -->
                        <button class="btn btn-warning btn-sm d-none" title="Descargar PowerPoint" disabled>
                            <i class="bi bi-file-earmark-ppt"></i>
                        </button>
                        <!-- Historial alumno -->
                        <button class="btn btn-info btn-sm btn-historial" data-alumno="{{ r.alumno_id }}" title="Ver Historial">
                            <i class="bi bi-clock-history"></i>
                        </button>
                        <!-- 3 Strikes (si tiene 3+) -->
                        {% if strikes.r.alumno_id %}
                        <a href="{% url 'reporte_general_tres_faltas_bilingue' %}?alumno_id={{ r.alumno_id }}" class="btn btn-danger btn-sm" title="3 Strikes">
                            <i class="bi bi-exclamation-triangle"></i>
                        </a>
                        {% else %}
                        <button class="btn btn-danger btn-sm d-none" disabled>
                            <i class="bi bi-exclamation-triangle"></i>
                        </button>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            {# --- Iterar Progress (solo bilingue) --- #}
            {% if area == "bilingue" %}
                {% for r in reportes_progress %}
                <tr>
                    <td>{{ r.alumno_nombre }}</td>
                    <td><span class="badge bg-primary">Progress</span></td>
                    <td>{{ r.fecha|date:"d/m/Y" }}</td>
                    <td>{{ r.grado }}</td>
                    <td>{{ r.usuario }}</td>
                    <td>
                        <span class="badge bg-success">Activo</span>
                    </td>
                    <td>
                        <!-- Editar -->
                        <a href="{% url 'editar_progress_report' r.pk %}" class="btn btn-primary btn-sm" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <!-- QR / PDF -->
                        <a href="{% url 'descargar_pdf_progress' r.pk %}" class="btn btn-secondary btn-sm" title="Descargar PDF/QR">
                            <i class="bi bi-qr-code"></i>
                        </a>
                        <!-- PowerPoint -->
                        <a href="{% url 'descargar_pdf_progress' r.pk %}?powerpoint=1" class="btn btn-warning btn-sm" title="Descargar PowerPoint">
                            <i class="bi bi-file-earmark-ppt"></i>
                        </a>
                        <!-- Historial alumno -->
                        <button class="btn btn-info btn-sm btn-historial" data-alumno="{{ r.alumno_id }}" title="Ver Historial">
                            <i class="bi bi-clock-history"></i>
                        </button>
                        <!-- 3 Strikes NO aplica para progress -->
                        <button class="btn btn-danger btn-sm d-none" disabled>
                            <i class="bi bi-exclamation-triangle"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- MODAL HISTORIAL (simple, puede mejorarse) -->
<div class="modal fade" id="modalHistorial" tabindex="-1" aria-labelledby="modalHistorialLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalHistorialLabel">Historial del Alumno</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="historial-content">Cargando historial...</div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL TRES FALTAS -->
<div class="modal fade" id="modalTresFaltas" tabindex="-1" aria-labelledby="modalTresFaltasLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTresFaltasLabel">Atención</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <i class="bi bi-exclamation-triangle display-3 text-warning"></i>
        <p class="mt-3 mb-1 fw-bold">Este alumno aún no tiene 3 reportes conductuales.</p>
        <p>El reporte PDF estará disponible cuando acumule <span style="font-weight: bold;">tres faltas conductuales.</span></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Aceptar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- DataTables -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<!-- Tu JS personalizado al final -->
<script src="{% static 'conducta/js/coordinador.js' %}"></script>

</body>
</html>
