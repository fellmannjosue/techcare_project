{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>
    {% if bulk %}Reglas por Días (Lote){% else %}{% if form.instance.pk %}Editar{% else %}Nueva{% endif %} Regla de Día{% endif %}
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 + FontAwesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

  <link rel="stylesheet" href="{% static 'reloj/css/reloj.css' %}">
</head>
<body class="bg-light">

<div class="d-flex" id="wrapper">
  <!-- Sidebar -->
  <nav class="bg-dark text-white sidebar flex-shrink-0 p-3" style="min-width:230px;">
    <div class="d-flex align-items-center mb-3">
      <img src="{% static 'accounts/img/ana-transformed.png' %}" alt="Logo" style="width:42px;" class="me-2">
      <span class="fs-5 fw-bold">TechCare</span>
    </div>
    <hr class="text-secondary">
    <ul class="nav nav-pills flex-column mb-auto">
      <li><a class="nav-link text-white" href="{% url 'reloj_dashboard' %}">
        <i class="fa-solid fa-clock me-2"></i> Reloj (Asistencia)</a></li>
      <li><a class="nav-link text-white" href="{% url 'reloj_reporte' %}">
        <i class="fa-solid fa-table me-2"></i> Generar Reporte</a></li>
      <li><a class="nav-link text-white" href="{% url 'reloj_grafica' %}">
        <i class="fa-solid fa-chart-bar me-2"></i> Ver Gráfica</a></li>
      <li><a class="nav-link text-white" href="{% url 'reloj_plantilla_list' %}">
        <i class="fa-solid fa-layer-group me-2"></i> Plantillas de Horario</a></li>
      <li><a class="nav-link text-white" href="{% url 'horarios_list' %}">
        <i class="fa-solid fa-user-clock me-2"></i> Asignaciones de Horario</a></li>
      <li><a class="nav-link text-white" href="{% url 'tiempo_por_hora' %}">
        <i class="fa-solid fa-hourglass-half me-2"></i> Tiempo por Hora</a></li>
      <li><a class="nav-link" href="{% url 'menu' %}">
        <i class="fa-solid fa-arrow-left me-2"></i> Volver al Menú</a></li>
    </ul>
  </nav>
  <!-- /Sidebar -->

  <!-- Main content -->
  <div class="flex-grow-1 d-flex flex-column min-vh-100">

    <!-- Header -->
    <nav class="navbar navbar-light bg-white shadow-sm px-3">
      <div class="container-fluid">
        <div class="navbar-brand d-flex align-items-center gap-3">
          <i class="fa-solid fa-calendar-day text-secondary"></i>
          <span class="fs-4">
            {% if bulk %}
              Reglas por Días (Lote)
            {% else %}
              {% if form.instance.pk %}Editar{% else %}Nueva{% endif %} Regla de Día
            {% endif %}
          </span>
        </div>
        <div class="d-flex gap-2">
          <a href="{% url 'reloj_plantilla_edit' plantilla.pk %}" class="btn btn-outline-secondary">
            <i class="fa-solid fa-arrow-left me-2"></i>Volver a Plantilla
          </a>
        </div>
      </div>
    </nav>
    <!-- /Header -->

    <div class="container py-4">

      <!-- Mensajes Django -->
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}

      <!-- Info -->
      {% if bulk %}
        <div class="alert alert-info d-flex align-items-center" role="alert">
          <i class="fa-solid fa-circle-info me-2"></i>
          Crea o actualiza reglas para <b>varios días</b> a la vez. Marca los días (L–D), indica si
          <b>Trabaja</b> y define los turnos de <b>mañana</b> y/o <b>tarde</b>.
        </div>
      {% else %}
        <div class="alert alert-info d-flex align-items-center" role="alert">
          <i class="fa-solid fa-circle-info me-2"></i>
          Configura el horario para un <b>día específico</b> (0=Lunes … 6=Domingo). Marca <b>Trabaja</b> si corresponde y completa
          los turnos de <b>mañana</b> y/o <b>tarde</b>.
        </div>
      {% endif %}

      <!-- Formulario -->
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <strong>Datos de la Regla</strong>
        </div>
        <div class="card-body">
          <form method="post" novalidate>
            {% csrf_token %}
            {{ form.non_field_errors }}

            {% if bulk %}
              <!-- MODO LOTE: Checkboxes de días -->
              <div class="mb-3">
                <label class="form-label d-block">Días de la semana</label>
                <div class="row">
                  <div class="col-12">
                    <!-- Render por defecto de MultipleChoiceField (checkboxes) -->
                    {{ form.weekdays }}
                    {% if form.weekdays.errors %}
                      <div class="text-danger small">{{ form.weekdays.errors }}</div>
                    {% endif %}
                  </div>
                </div>
                <small class="text-muted d-block mt-1">0=Lunes, 1=Martes, 2=Miércoles, 3=Jueves, 4=Viernes, 5=Sábado, 6=Domingo</small>
              </div>
            {% else %}
              <!-- MODO INDIVIDUAL: Select día -->
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Día (0=Lunes … 6=Domingo)</label>
                  {{ form.weekday }}
                  {% if form.weekday.errors %}
                    <div class="text-danger small">{{ form.weekday.errors }}</div>
                  {% endif %}
                </div>
              </div>
            {% endif %}

            <!-- Trabaja -->
            <div class="row g-3">
              <div class="col-md-4 d-flex align-items-end">
                <div class="form-check mt-2">
                  {{ form.trabaja }}
                  <label class="form-check-label ms-1">Trabaja este día</label>
                </div>
                {% if form.trabaja.errors %}
                  <div class="text-danger small d-block">{{ form.trabaja.errors }}</div>
                {% endif %}
              </div>
            </div>

            <hr>

            <!-- Turno Mañana -->
            <div class="row g-3 align-items-end">
              <div class="col-12">
                <span class="fw-semibold">Turno de Mañana (opcional)</span>
              </div>
              <div class="col-md-3">
                <label class="form-label">Entrada Mañana</label>
                {{ form.entrada_manana }}
                {% if form.entrada_manana.errors %}
                  <div class="text-danger small">{{ form.entrada_manana.errors }}</div>
                {% endif %}
              </div>
              <div class="col-md-3">
                <label class="form-label">Salida Mañana</label>
                {{ form.salida_manana }}
                {% if form.salida_manana.errors %}
                  <div class="text-danger small">{{ form.salida_manana.errors }}</div>
                {% endif %}
              </div>
            </div>

            <!-- Turno Tarde -->
            <div class="row g-3 align-items-end mt-1">
              <div class="col-12">
                <span class="fw-semibold">Turno de Tarde (opcional)</span>
              </div>
              <div class="col-md-3">
                <label class="form-label">Entrada Tarde</label>
                {{ form.entrada_tarde }}
                {% if form.entrada_tarde.errors %}
                  <div class="text-danger small">{{ form.entrada_tarde.errors }}</div>
                {% endif %}
              </div>
              <div class="col-md-3">
                <label class="form-label">Salida Tarde</label>
                {{ form.salida_tarde }}
                {% if form.salida_tarde.errors %}
                  <div class="text-danger small">{{ form.salida_tarde.errors }}</div>
                {% endif %}
              </div>
            </div>

            <div class="alert alert-secondary mt-3 py-2">
              <small>
                Reglas:
                <ul class="mb-0">
                  <li>Si <b>Trabaja</b> está desmarcado, las horas se deshabilitan automáticamente.</li>
                  <li>Para cada turno usado, completa <b>Entrada</b> y <b>Salida</b> (ambas).</li>
                  <li>Puedes usar sólo mañana, sólo tarde, o ambos (turno partido).</li>
                  {% if bulk %}
                    <li>Se aplicará a <b>todos los días seleccionados</b>. Días existentes se <b>actualizan</b> y los que no existan se <b>crean</b>.</li>
                  {% endif %}
                </ul>
              </small>
            </div>

            <div class="mt-3 d-flex gap-2">
              <button type="submit" class="btn btn-primary">
                <i class="fa-solid fa-save me-2"></i>Guardar
              </button>
              <a href="{% url 'reloj_plantilla_edit' plantilla.pk %}" class="btn btn-outline-secondary">Cancelar</a>
            </div>
          </form>
        </div>
      </div>

      <div class="mt-3">
        <a href="{% url 'reloj_plantilla_edit' plantilla.pk %}" class="btn btn-outline-secondary">
          <i class="fa-solid fa-arrow-left me-2"></i>Volver a Plantilla
        </a>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
  // Helper: devuelve true si un input existe
  function el(id){ return document.getElementById(id); }

  // Habilita/Deshabilita horas según "trabaja"
  function toggleHorasPorTrabaja() {
    // 'id_trabaja' existe tanto en RuleBulkForm como en ScheduleRuleForm
    const chk = el('id_trabaja');
    const disabled = chk ? !chk.checked : false;

    ['id_entrada_manana','id_salida_manana','id_entrada_tarde','id_salida_tarde']
      .forEach(id => {
        const input = el(id);
        if (input) {
          input.disabled = disabled;
          if (disabled) input.value = '';
        }
      });
  }

  // Valida pares entrada/salida si alguno está lleno
  function validarParesHoras(e) {
    const trabaja = el('id_trabaja') ? el('id_trabaja').checked : true;
    if (!trabaja) return true; // si no trabaja, no validamos

    const em = el('id_entrada_manana')?.value || '';
    const sm = el('id_salida_manana')?.value || '';
    const et = el('id_entrada_tarde')?.value || '';
    const st = el('id_salida_tarde')?.value || '';

    // si llenas una de un par, debes llenar la otra
    if ((em && !sm) || (!em && sm) || (et && !st) || (!et && st)) {
      e.preventDefault();
      alert('Completa las parejas de horas: Entrada/Salida Mañana y/o Entrada/Salida Tarde.');
      return false;
    }
    return true;
  }

  document.addEventListener('DOMContentLoaded', function () {
    // Aplica clases por si el widget no las trae
    ['id_trabaja','id_entrada_manana','id_salida_manana','id_entrada_tarde','id_salida_tarde','id_weekday']
      .forEach(id => {
        const node = el(id);
        if (!node) return;
        if (node.type === 'checkbox') {
          node.classList.add('form-check-input');
        } else if (!node.classList.contains('form-control') && node.tagName === 'INPUT') {
          node.classList.add('form-control');
        } else if (node.tagName === 'SELECT') {
          node.classList.add('form-select');
        }
      });

    // Para MultipleChoiceField (bulk) Django genera ids tipo id_weekdays_0..6
    const bulkWeekdayGroup = document.querySelectorAll('input[id^="id_weekdays_"]');
    if (bulkWeekdayGroup.length) {
      bulkWeekdayGroup.forEach(cb => cb.classList.add('form-check-input'));
      // Estilizar contenedor: si quieres, puedes envolver con .form-check en tu widget
    }

    // Bind estado inicial y onChange
    const chk = el('id_trabaja');
    if (chk) {
      chk.addEventListener('change', toggleHorasPorTrabaja);
      toggleHorasPorTrabaja(); // inicial
    }

    // Validación en submit
    const form = document.querySelector('form');
    if (form) {
      form.addEventListener('submit', validarParesHoras);
    }
  });
</script>
</body>
</html>
